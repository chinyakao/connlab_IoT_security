<!DOCTYPE html>
<html lang="zh-TW">
<head>
  	<meta charset="utf-8">

    <title>JavaScript MQTT WebSocket Example</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>
	<!-- <script type="text/javascript" src="websockets.js"></script> -->
	<script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <meta http-equiv="refresh" content="20">
    <style type="text/css">
      #mynetwork {
        width: 600px;
        height: 400px;
        border: 1px solid lightgray;
      }
    </style>
</head>
<body>
	<h1>Network Graph</h1>
	<div id="mynetwork"></div>
	<script>
		//NETWORK GRAPH
		// create an array with nodes
		var nodes = new vis.DataSet([
			{id: 'main_ip', label: '10.255.255.N', x: 0, y: 0, color: {border: "gray", background: "lightgray"}},
			{id: 'Server', label: '172.105.219.146',x: -1, y: 0,color: {border: "black", background: "lightgray"}},
		]);
		// create an array with edges
		var edges = new vis.DataSet([
			{id: 0, from: 'main_ip', to: 'Server'}
		]);
		// create a network
		var container = document.getElementById('mynetwork');
		var data = {
			nodes: nodes,
			edges: edges
		};
		var options = {};
		var network = new vis.Network(container, data, options);

		//MQTT
		var mqtt;
		var reconnectTimeout = 2000;
		var host="10.255.255.254"; //change this
		var port= 61883;

		function onFailure(message) {
			console.log("Connection Attempt to Host "+host+"Failed");
			setTimeout(MQTTconnect, reconnectTimeout);
		}
		function onMessageArrived(msg)
		{
			var str_msg = msg.payloadString;
			var obj_msg = JSON.parse(str_msg);
			// console.log(obj_msg);
			// console.log("src:"+ obj_msg["src_ip"]+ "// dest:"+ obj_msg["dest_ip"]+ " // oob.out: " +obj_msg["oob.out"]);

			//內網連外面
			if(obj_msg["oob.out"]=="eth0")
			{
				if(nodes.get('main_ip').label == '10.255.255.N'){
					nodes.update({id:'main_ip', label: obj_msg["src_ip"]});
				}
				var out_ip = obj_msg["dest_ip"];
				var out_edge = out_ip + "1";
				//NEW node and new connect
				if(nodes.get(out_ip) == null && edges.get(out_edge) == null)
				{
					nodes.add({id: out_ip, label: out_ip, color: {border:"#2B7CE9", background: "#CCDDFF"}});
					edges.add({id: out_edge, from: 'main_ip', to: out_ip, arrows:{to: {enabled: true, type: "triangle"}}, color:"#2B7CE9", width: 1});
				}else
				{
					//old node and NEW connect
					if(edges.get(out_edge) == null)
					{
						edges.add({id: out_edge, from: 'main_ip', to: out_ip, arrows:{to: {enabled: true, type: "triangle"}}, color:"#2B7CE9", width: 1});
					}else
					{	//old node and MORE connect
						var new_width = edges.get(out_edge).width + 0.1;
						// console.log(new_width);
						edges.update({id: out_edge, width: new_width});
					}
				}
				
				console.log("內到外");		
				console.log("src:"+ obj_msg["src_ip"]+ "// dest:"+ obj_msg["dest_ip"]);
				console.log("oob.in: "+ obj_msg["oob.in"]+ " // oob.out: " +obj_msg["oob.out"]);

			}else if (obj_msg["oob.in"]=="eth0")
			{
				if(nodes.get('main_ip').label == '10.255.255.N'){
					nodes.update({id:'main_ip', label: obj_msg["dest_ip"]});
				}
				//外面連Gateway
				if(obj_msg["oob.out"]=="")
				{
					var out_ip = obj_msg["src_ip"];
					var out_edge = out_ip + "3";
					//NEW node and new connect
					if(nodes.get(out_ip) == null && edges.get(out_edge) == null)
					{
						nodes.add({id: out_ip, label: out_ip, color: {border: "orange", background: "lightyellow"}});
						edges.add({id: out_edge, from: out_ip, to: 'Server', arrows:{to: {enabled: true, type: "triangle"}}, width: 1});

					}else
					{	//old node and MORE connect
						var new_width = edges.get(out_edge).width + 0.1;
						// console.log(new_width);
						edges.update({id: out_edge, width: new_width});
					}

					console.log("外到S")					
					console.log("src:"+ obj_msg["src_ip"]+ "// dest:"+ obj_msg["dest_ip"]);
					console.log("oob.in: "+ obj_msg["oob.in"]+ " // oob.out: " +obj_msg["oob.out"]);
				}else
				{ //外面連內網
					var out_ip = obj_msg["src_ip"];
					var out_edge = out_ip + "2";
					//NEW node and new connect					
					if(nodes.get(out_ip) == null && edges.get(out_edge) == null)
					{
						nodes.add({id: out_ip, label: out_ip, color: {border: "green", background: "#CCFF99"}});
					//NEW node and new connect
						edges.add({id: out_edge, from: out_ip, to: 'main_ip', arrows:{to: {enabled: true, type: "triangle"}}, color:"green", width: 1});
					}else
					{	//old node and NEW connect
						if(edges.get(out_edge) == null)
						{
							edges.add({id: out_edge, from: out_ip, to: 'main_ip', arrows:{to: {enabled: true, type: "triangle"}}, color:"green", width: 1});
						}else
						{	//old node and MORE connect
							var new_width = edges.get(out_edge).width + 0.1;
							// console.log(new_width);
							edges.update({id: out_edge, width: new_width});
						}
					}
					

					console.log("外到內");
					console.log("src:"+ obj_msg["src_ip"]+ "// dest:"+ obj_msg["dest_ip"]);
					console.log("oob.in: "+ obj_msg["oob.in"]+ " // oob.out: " +obj_msg["oob.out"]);
				}
			}else{
				console("I AM OUT!!!!!!!!!!!!1");
				console.log("src:"+ obj_msg["src_ip"]+ "// dest:"+ obj_msg["dest_ip"]);
				console.log("oob.in: "+ obj_msg["oob.in"]+ " // oob.out: " +obj_msg["oob.out"]);

			}
			network.setData(data);
		}

		function onConnect() {
		// Once a connection has been made, make a subscription and send a message.

			console.log("Connected ");
			mqtt.subscribe("traffic/172-105-219-146");
			// message = new Paho.MQTT.Message("Hello World");
			// message.destinationName = "traffic/172-105-219-146";
			// mqtt.send(message);
		}
		function MQTTconnect() {
			console.log("connecting to "+ host +" "+ port);
			mqtt = new Paho.MQTT.Client(host,port,"clientjs");
			//document.write("connecting to "+ host);
			var options = {
				timeout: 3,
				onSuccess: onConnect,
				onFailure: onFailure,
			};
			mqtt.onMessageArrived = onMessageArrived;

			mqtt.connect(options); //connect
		}

		MQTTconnect();
	</script>
	
</body>	
</html>